@page "/loop-ref-example"

<h3>循环中使用 ref 示例</h3>

<button @onclick="ShowAllMessages" class="btn btn-primary">显示所有消息</button>
<button @onclick="UpdateAllMessages" class="btn btn-secondary">更新所有消息</button>

@foreach (var item in items)
{
	<ChildComponent @ref="componentRefs[item.Id]"
					Id="item.Id"
					Message="@item.Message"
					OnMessageChanged="HandleMessageChanged" />
}

@code {
	private List<ItemModel> items = new();
	private Dictionary<int, ChildComponent?> componentRefs = new();

	protected override void OnInitialized()
	{
		items = new List<ItemModel>
		{
			new ItemModel { Id = 1, Message = "第一条消息" },
			new ItemModel { Id = 2, Message = "第二条消息" },
			new ItemModel { Id = 3, Message = "第三条消息" }
		};
		// 预先初始化字典
		foreach (var item in items)
		{
			componentRefs[item.Id] = null;
		}
	}

	private void ShowAllMessages()
	{
		foreach (var component in componentRefs.Values)
		{
			component?.ShowCurrentMessage();
		}
	}

	private void UpdateAllMessages()
	{
		foreach (var item in items)
		{
			if (componentRefs.TryGetValue(item.Id, out var component) && component != null)
			{
				component.UpdateMessage($"更新后的消息 {item.Id}");
			}
		}
	}

	private void HandleMessageChanged((int Id, string Message) data)
	{
		Console.WriteLine($"收到消息更新 - ID: {data.Id}, 消息: {data.Message}");

		var item = items.FirstOrDefault(i => i.Id == data.Id);
		if (item != null)
		{
			item.Message = data.Message;
			StateHasChanged();
		}
	}

	public class ItemModel
	{
		public int Id { get; set; }
		public string Message { get; set; } = string.Empty;
	}
}